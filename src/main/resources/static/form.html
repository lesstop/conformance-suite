<!DOCTYPE html>
<html>

<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <title>OIDF Conformance: Test Plan</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
    <link rel="stylesheet" type="text/css" href="css/layout.css">

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.js" integrity="sha256-vS9J2VYhvwAfh2znnLdkhemFPEpx6YoZEhExqBPT5ys=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script type="text/javascript" src="js/fapi.ui.js"></script>

    <style>
        #pdf-viewer-container {
            width: 100%;
            height: 1200px;
            border: 1px solid #bbb;
        }
        #pdf-viewer {
            width: 100%;
            height: 100%;
        }
        .disclaimer, .hidden {
            display: none;
        }

    </style>
</head>

<body>

<div class="pageHeader container-fluid">
    <div class="row">
        <div class="col-md-8">
            <a href="index.html"><img src="/images/openid.png"></a>
        </div>
        <div id="userInfoHolder" class="col-md-4"></div>
    </div>
</div>
<div class="clearfix"></div>

<div class="container-fluid">
    <div id="planDetail">
        <div class="header"></div>
        <div class="content container-fluid">
            <!-- main page is rendered here -->

            <!-- 404 content -->
            <div class="card _404 hidden">
                <div class="card-body bg-danger bg-opacity-100 text-white">
                    <div class="row">
                            <div class="row">
                                <div class="col-md-12">
                                    Not found.</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="d-grid gap-1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="container-fluid">

    <div class="row mx-1 mt-3">
        <div class="col-md-5">
            <div class="">
                <h3 class="ps-0 mt-0"><strong>Instructions</strong></h3>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
                <p>
                    <button id="click-me" type="button" class="btn btn-primary">Click me</button>
                </p>
            </div>
        </div>

        <div class="col-md-7">
            <div id="pdf-viewer-container">
                <iframe id="pdf-viewer" ></iframe>
            </div>
        </div>
    </div>
</div>

<!-- loading modal -->
<div class="modal" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="loadingLabel">Loading...</h4>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <img src="/images/spinner.gif" width="100px" height="30px" alt="" />
                </div>
                <div>
                    <span id="loadingMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- error modal -->
<div class="modal" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="errorLabel">Error</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Error: <span id="errorMessage"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<footer class="pageFooter mt-0">
    <span class="muted">OpenID Foundation conformance suite</span>
</footer>


<script>

    const origin = `${document.location.protocol}//${document.location.host}`;
    const now = new Date();
    var planId, public, event, envelopeId, shouldPrefill, planLoadError, profile, suite, started, date = '';

    function getPlan(planId, public) {
        return fetch('/api/plan/' + encodeURIComponent(planId) + (public ? '?public=true' : ''))
            .then(response => {
                if (!response.ok) {
                    return Promise.reject(response);
                }
                return response.json();
            })
            .then(data => {
                document.querySelector('.content').insertAdjacentHTML('beforeend',
                    FAPI_UI.logTemplates.PLAN_HEADER({ plan: data, public: public, variant: FAPI_UI.formatVariant(data.variant)})
                );
                profile = data.certificationProfileName,
                suite = `${document.location.host} ${data.version}`,
                started = data.started.substring(0, 10),
                date = new Date(now.getTime() - (now.getTimezoneOffset()*60*1000)).toISOString().substring(0, 10);
            })
            .catch(ex => {
                planLoadError = true;
                handleSuiteError(ex);
            });
    }

    function handleSuiteError(error) {
        if (error instanceof Response) {
            if (error.status === 404) {
                document.querySelector('._404').classList.remove('hidden');
            }
            var message = error.statusText;
            let responseClone = error.clone();
            error.text().then(textError => {
                messageParsed = true;
                try {
                    const errorObj = JSON.parse(textError);
                    if (errorObj.error.length != 0) {
                        message = errorObj.error;
                    }
                } catch (e) { }
                FAPI_UI.showError({code: error.status.toString(), error: message});
            })
            .catch(_ => {
                responseClone.json().then(jsonError => {
                    if (typeof (jsonError) === 'string' && jsonError.length != 0) {
                        message = jsonError;
                    }
                    FAPI_UI.showError({code: error.status.toString(), error: message});
                })
                .catch(_ => {
                    FAPI_UI.showError({code: error.status.toString(), error: error.statusText});
                });
            });
        } else {
            FAPI_UI.showError({code: "", error: error});
        }
    }

    function loadDocumentInViewer(event) {
        var redirectUrl = 'lib/pdfjs-3.10.111-dist/web/viewer.html?file=';
        if (!planLoadError) {
            if (event && event === 'signing_complete' && envelopeId) {
                redirectUrl += encodeURIComponent(`/api/plan/${planId}/sign/${envelopeId}`);
            } else {
                shouldPrefill = true;
                redirectUrl += encodeURIComponent('/files/OpenID-Certification-of-Conformance.pdf');
            }
        }
        let viewerOptions = '#page=1&pagemode=none&zoom=100';
        document.querySelector('#pdf-viewer').src = redirectUrl + viewerOptions;
    }

    document.addEventListener('DOMContentLoaded', _ => {
        let urlParams = new URLSearchParams(window.location.search);
        planId = urlParams.get('plan');
        public = Boolean(urlParams.get('public'));
        event = urlParams.get('event');
        envelopeId = urlParams.get('envelopeId');

        FAPI_UI.loadPlanTemplates()
            .then(_ => {
                return FAPI_UI.getUserInfo();
            }).then(_ => {
                return getPlan(planId, public);
            }).then(_ => {
                loadDocumentInViewer(event);
            });
        FAPI_UI.showBusy();
    });

    document.querySelector('#click-me').addEventListener('click', _ => {
        window.frames[0].postMessage({ "event": "getDocument" }, origin);
    });

    window.addEventListener('message', async (evt) => {
        if (evt.origin === origin) {

          if(evt.data.event === 'pagesLoaded') {
            let pdfValues = { "event": "prefill", profile, suite, started, date };
            FAPI_UI.hideBusy();
            if(shouldPrefill) {
                window.frames[0].postMessage(pdfValues, origin);
            }
          }

          if(evt.data.event === 'documentData') {
            const request = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "documentData": btoa(String.fromCharCode.apply(null, evt.data.documentData ))})
            };

            fetch(`/api/plan/${planId}/sign`, request)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error, status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.location.href = data.recipentSigningUri;
                })
                .catch(handleSuiteError);
          }
        }
      });

    document.addEventListener('webviewerloaded', _ => {
        window.frames[0].postMessage({ "event": "viewerLoaded" }, origin)
    });

</script>

</body>
</html>
