<!DOCTYPE html>
<html>

<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <title>OIDF Conformance: Test Plan</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
    <link rel="stylesheet" type="text/css" href="css/layout.css">
    <link rel="stylesheet" type="text/css" href="lib/dropzone-6.0.0b2/basic.css">

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.js" integrity="sha256-vS9J2VYhvwAfh2znnLdkhemFPEpx6YoZEhExqBPT5ys=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script type="text/javascript" src="js/fapi.ui.js"></script>
    <script type="text/javascript" src="lib/dropzone-6.0.0b2/dropzone-min.js"></script>

    <style>
        .disclaimer, .hidden {
            display: none;
        }
    </style>
</head>

<body>

<div class="pageHeader container-fluid">
    <div class="row">
        <div class="col-md-8">
            <a href="index.html"><img src="/images/openid.png"></a>
        </div>
        <div id="userInfoHolder" class="col-md-4"></div>
    </div>
</div>

<div class="clearfix"></div>

<div class="container-fluid">
    <div id="planDetail">
        <div class="header"></div>
        <div class="content container-fluid">
            <!-- main page is rendered here -->

            <!-- 404 content -->
            <div class="card _404 hidden">
                <div class="card-body bg-danger bg-opacity-200 text-white">
                    <div class="row">
                        <div class="col-md-12">
                            Not found.</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">

    <div class="row mx-1 mt-3">

        <div class="col-md-6">
            <div class="">
                <h2 class="ps-0 mt-0 mb-2"><strong>Publish for certification</strong></h2>
                <p>
                    You are creating a certification package for a relying party profile, which means that
                    you will need to provide evidence demonstrating the behavior of the relying party for each test.
                    This can take the form of RP log files, screen captures (image files), or both.
                    You must upload a zip file that contains the client data.
                </p>
                <p>Please note the following conventions for the zip file:
                    <ul>
                        <li>Files should be named consistently using the test name as the file name prefix.
                            For example the log file for the test <code>fapi1-advanced-final-client-test-invalid-shash</code> should be named
                            <code>fapi1-advanced-final-client-test-invalid-shash.log</code> or similar.</li>
                        <li>If more than one file needs to be included for a test then they should be named
                            <code>fapi1-advanced-final-client-test-invalid-shash-1.log</code>, <code>fapi1-advanced-final-client-test-invalid-shash-2.log</code> etc.</li>
                        <li>
                            When a test plan contains the same test multiple times, e.g for an hybrid profile, then the filenames must also contain the response type. For example for an hybrid test plan, client log files for <code>oidcc-client-test-invalid-iss</code> should be named as follows:
                            <ul>
                                <li><code>oidcc-client-test-invalid-iss_code-id_token.log</code></li>
                                <li><code>oidcc-client-test-invalid-iss_code-token.log</code></li>
                                <li><code>oidcc-client-test-invalid-iss_code-id_token-token.log</code></li>
                            </ul>
                        </li>
                    </ul>
                </p>

                <div class="mt-4">

                    <div>
                        <label for="clientSideData" class="form-label"><strong>Choose client data zip-file (max 10 MB):</strong></label>
                        <input class="form-control" id="clientSideData" name="clientSideData" accept="application/zip" type="file" accept=".zip, application/zip"></input>
                    </div>
                        
                    <div class="mt-3">
                        <button class="btn btn-success me-2 disabled" id="continue">Continue <i class="bi bi-chevron-double-right"></i></button>
                    </div>

                    <script>
                        
                        document.querySelector('#clientSideData').addEventListener('change', (evt) => {
                            let inputElement = evt.target;
                            if (inputElement.files.length > 0) {
                                let file = inputElement.files[0];
                                console.log(file);
                                if (file.type === 'application/zip') {
                                    if (file.size > 10 * 1024 * 1024) { // 10 MB in bytes
                                        alert('File size exceeds 10 MB. Please optimize the zip file contents by reducing size of log files or compressing images.');
                                        inputElement.value = '';
                                        document.querySelector('#continue').classList.add('disabled');
                                    } else {
                                        document.querySelector('#continue').classList.remove('disabled');
                                    }
                                } else {
                                    document.querySelector('#continue').classList.add('disabled');
                                    alert('Please choose a zip file.');
                                }
                            }
                        });

                        document.querySelector('#continue').addEventListener('click', () => {
                            let confirmationModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('certificationPackageModal'));
                            confirmationModal.show();
                        });

                    </script>
                </div>

    <!-- Certification submission modal -->
    <div class="modal" id="certificationPackageModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content pad28">
                <div class="modal-header">
                    <h4 class="modal-title" id="errorLabel">Publish for certification</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="form" name="certificationPackageForm" id="certificationPackageForm" action="" method="post" enctype="multipart/form-data" >
                    <div id="certificationPackageFormModalBody" class="modal-body">
                    <div id="certificationPackageFormErrors"></div>
                    <p><strong>Clicking the &quot;Create Certification Package&quot; button will trigger the following:</strong></p>
                    <ol class="top15">
                        <li>
                            <strong>The test plan will be published.</strong>
                            <p class="form-text">This will make all keys, secrets, and all other test information publicly visible.</p>
                        </li>
                        <li>
                            <strong>The test plan will be marked as immutable.</strong>
                            <p class="form-text">You will not be able to run tests under this plan, once you click the Create Certification Package button.</p>
                        </li>
                        <li>
                            <strong>A zip file containing your certification submission package will be downloaded to your computer.</strong>
                            <p class="form-text">Please follow <a class="darkblue" href="https://openid.net/certification/instructions/" target="instructions">the submission instructions</a>
                            to complete the certification process.</p>
                        </li>
                    </ol>

                    <div id="certificationPackageDownloaded" class="modal-body" hidden>
                        <p>The certification package zip file is being downloaded to your computer. You may close this dialog, and when the download
                            is complete then you will find the zip file in your browser download directory.</p>
                        <p>Please rename the zip file according to <a class="darkblue" href="https://openid.net/certification/op_submission/" target="instructions">the instructions</a>
                            and then proceed to <a class="darkblue" href="https://openid.atlassian.net/servicedesk/customer/portal/3/group/3/create/10016" target="ocs">the certification request form</a>
                            to submit.</p>
                    </div>

                    <div class="modal-footer">
                        <button id="cancelCertificationPackageFormModal" type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button id="certificationPackageFormSubmitBtn" type="submit" class="btn btn-sm btn-primary bg-gradient border border-secondary" disabled>Create Certification Package</button>
                        <button id="closeCertificationPackageFormModal" type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" hidden>Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>&nbsp;</p>

            </div>
        </div>

        <!--div class="col-md-3" style="border: 1px solid red;">

            <form style="border: 1px solid blue; height: 100%" class="dropzone" id="client-data"></form>

        </div-->



    </div>

<!-- loading modal -->
<div class="modal" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="loadingLabel">Loading...</h4>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <img src="/images/spinner.gif" width="100px" height="30px" alt="" />
                </div>
                <div>
                    <span id="loadingMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- error modal -->
<div class="modal" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="errorLabel">Error</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Error: <span id="errorMessage"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

</div>

<footer class="pageFooter mt-0">
    <span class="muted">OpenID Foundation conformance suite</span>
</footer>


<script>

    const origin = `${document.location.protocol}//${document.location.host}`;
    const now = new Date();
    var planId, public, event, envelopeId, shouldPrefill, planLoadError, profile, suite, started, date = '';

    function getPlan(planId, public) {
        return fetch('/api/plan/' + encodeURIComponent(planId) + (public ? '?public=true' : ''))
            .then(response => {
                if (!response.ok) {
                    return Promise.reject(response);
                }
                return response.json();
            })
            .then(data => {
                document.querySelector('.content').insertAdjacentHTML('beforeend',
                    FAPI_UI.logTemplates.PLAN_HEADER({ plan: data, public: public, variant: FAPI_UI.formatVariant(data.variant)})
                );
                profile = data.certificationProfileName,
                suite = `${document.location.host} ${data.version}`,
                started = data.started.substring(0, 10),
                date = new Date(now.getTime() - (now.getTimezoneOffset()*60*1000)).toISOString().substring(0, 10);
        })
            .catch(ex => {
                planLoadError = true;
                handleSuiteError(ex);
            });
    }

    function handleSuiteError(error) {
        console.error(error);
        if (error instanceof Response) {
            if (error.status === 404) {
                document.querySelector('._404').classList.remove('hidden');
            }
            var message = error.statusText;
            let responseClone = error.clone();
            error.text().then(textError => {
                messageParsed = true;
                try {
                    const errorObj = JSON.parse(textError);
                    if (errorObj.error.length != 0) {
                        message = errorObj.error;
                    }
                } catch (e) { }
                FAPI_UI.showError({code: error.status.toString(), error: message});
            })
            .catch(_ => {
                responseClone.json().then(jsonError => {
                    if (typeof (jsonError) === 'string' && jsonError.length != 0) {
                        message = jsonError;
                    }
                    FAPI_UI.showError({code: error.status.toString(), error: message});
                })
                .catch(_ => {
                    FAPI_UI.showError({code: error.status.toString(), error: error.statusText});
                });
            });
        } else {
            FAPI_UI.showError({code: "", error: error});
        }
    }

    /*
    function setupDropZone() {
        let myDropzone = new Dropzone("form.dropzone", {
            url: `/api/plan/${planId}/certificationpackage`,
            paramName: 'clientSideData',
            maxFilesize: 100, // MB,
            maxFiles: 1,
            acceptedFiles: 'application/zip',
            disablePreviews: false,
            createImageThumbnails: true,
            accept: function(file, done) {
                if (file.name == "justinbieber.jpg") {
                    done("Naha, you don't.");
                }
                //else { done(); }
            }
        });

        Dropzone.options.clientData = {
            paramName: "client-data.zip",
            maxFilesize: 100, // MB
            accept: function(file, done) {
                if (file.name == "justinbieber.jpg") {
                    done("Naha, you don't.");
                }
                else { done(); }
            }
        };
    }
    */

    document.addEventListener('DOMContentLoaded', _ => {
        let urlParams = new URLSearchParams(window.location.search);
        let planId = urlParams.get('plan');
        let public = Boolean(urlParams.get('public'));

        FAPI_UI.loadPlanTemplates()
            .then(_ => {
                return FAPI_UI.getUserInfo();
            }).then(_ => {
                return getPlan(planId, public);
            }).then(_ => {
                FAPI_UI.hideBusy();
            });
        FAPI_UI.showBusy();
    });

</script>

</body>
</html>
