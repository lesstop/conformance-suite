<!DOCTYPE html>
<html>

<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <title>OIDF Conformance: Test Plan</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <!-- Boostrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
    <link rel="stylesheet" type="text/css" href="css/layout.css">

    <!-- Popper (necessary for Bootstrap's tooltips) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.js" integrity="sha256-vS9J2VYhvwAfh2znnLdkhemFPEpx6YoZEhExqBPT5ys=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>

    <script type="text/javascript" src="js/fapi.ui.js"></script>
</head>

<body>

    <div class="pageHeader container-fluid">
        <div class="row">
            <div class="col-md-8">
                <a href="index.html"><img src="/images/openid.png"></a>
            </div>
            <div id="userInfoHolder" class="col-md-4"></div>
        </div>
    </div>
    <div class="clearfix"></div>

    <!-- error modal -->
    <div class="modal" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="errorLabel">Error</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Error: <span id="errorMessage"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- loading modal -->
    <div class="modal" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="loadingLabel">Loading...</h4>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <img src="/images/spinner.gif" width="100px" height="30px" />
                    </div>
                    <div>
                        <span id="loadingMessage"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Config modal popup -->
    <div class="modal" id="configModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">
                        <button class="btn-clipboard btn btn-sm" data-clipboard-target="#config" alt="Copy config to clipboard" title="Copy config to clipboard"><span class="bi bi-box-arrow-in-right"></span></button>
                        Configuration for <code id="configTestId" class="text-muted"></code>
                    </h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="wrapLongStrings row-bg-light p-1">
                        <pre id="config"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Publish modal -->
    <div class="modal" id="publishModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Publish</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure? This will make all keys, secrets, and all other test information publicly visible.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal" data-publish="everything">Publish</button>
                    <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Certification submission modal -->
    <div class="modal" id="certificationPackageModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content pad28">
                <div class="modal-header">
                    <h4 class="modal-title">Prepare Certification Submission Package</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form class="form" name="document-provision-form" id="document-provision-form">
                    <div id="certificationPackageFormModalBody" class="modal-body">
                        <p>
                            In order to publish your test plan for certification, you will need to submit a filled out and
                            signed <strong>certification of conformance</strong> document.
                        </p>
                        <p>
                            If you already have the document, please upload it in order to continue. Otherwise, please
                            proceed to the next step to fill it out.
                        </p>
                        <p>
                            <ol class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-start" style="border: none;">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold"><input id="upload-document-choice" class="form-check-input me-2" type="radio" name="document">
                                        <label for="clientSideData" class="form-label">I would like to upload the document:<br/>
                                            <input class="form-control mt-1" id="certificationOfConformancePdf" name="certificationOfConformancePdf" type="file" accept=".pdf, application/pdf"></input>
                                        </label>
                                    </div>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold"><input id="fillout-document-choice" class="form-check-input me-2" type="radio" name="document">I would like to fill out the document online.</div>
                                    </div>
                                </li>
                            </ol>
                        </p>

                    </div>

                    <div class="modal-footer">
                        <button id="cancelCertificationPackageFormModal" type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Cancel</button>
                        <a id="certificationPackageContinue" class="btn btn-sm btn-success bg-gradient border border-secondary disabled">Continue</a>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- Rerun test confirmation modal -->
    <div class="modal" id="reRunTestModal" tabindex="-1" role="dialog" aria-labelledby="errorLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Run test confirmation</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to rerun this test? It is owned by a different user.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-danger bg-gradient border border-secondary" data-bs-dismiss="modal" id="reRunTestModalBtn">Sure, Run it</button>
                    <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete plan modal -->
    <div class="modal" id="deletePlanModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content pad28">
                <div class="modal-header">
                    <h4 class="modal-title" >Delete plan</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="deleteMutablePlanModalBody" class="modal-body">

                    <p><strong>Clicking the "Delete plan" button will permanently and irrevocably:</strong>
                        <ul>
                            <li>Delete the test plan.</li>
                            <li>Delete the test plan configuration.</li>
                            <li>Delete the individual tests and logs belonging to the plan.</li>
                        </ul>
                    </p>
                    <p class="top10"><strong>This action cannot be undone and the data cannot be recovered after deletion.</strong></p>
                    <p class="top10">After deletion, this page will be reloaded and you will see an <strong>HTTP 404 Not Found</strong>
                    error, confirming that the deletion was successful.</p>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-light bg-gradient border border-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="confirmDeletePlanBtn" type="button" class="btn btn-sm btn-danger bg-gradient border border-secondary">Delete plan</button>
                </div>

            </div>
        </div>
    </div>

    <!-- resident DOM -->
    <div class="container-fluid">
        <div id="planDetail">
            <div class="header"></div>
            <div class="content container-fluid">
                <!-- main page is rendered here -->
            </div>
        </div>
    </div>

    <script type="text/javascript">

        function getPlan(planId, public) {
            return fetch('/api/plan/' + encodeURIComponent(planId) + (public ? '?public=true' : ''))
            .then((response) => {
                if (!response.ok) {
                    return Promise.reject(response);
                }

                return response.json();
            })
            .then((data) => {
                document.querySelectorAll('.content')?.forEach(function(element) {
                    element.insertAdjacentHTML('beforeend', FAPI_UI.logTemplates.PLAN_START({ plan: data, public: public, variant: FAPI_UI.formatVariant(data.variant)}));
                });

                if (document.getElementById('downloadAllBtn') != null) {
                    document.getElementById('downloadAllBtn').onclick = function(evt) {
                        evt.preventDefault();
                        window.open('/api/plan/exporthtml/' + encodeURIComponent(planId) + (public ? '?public=true' : ''));
                    };
                }

                // wire up configuration button
                if (document.getElementById('showConfigBtn') != null) {
                    document.getElementById('showConfigBtn').onclick = function(evt) {
                        evt.preventDefault();
                        document.getElementById('config').innerHTML = _.escape(JSON.stringify(data.config, null, 4));
                        document.getElementById('configTestId').innerHTML = _.escape(planId);

                        var myModalEl = document.getElementById('configModal');
                        var modal     = bootstrap.Modal.getOrCreateInstance(myModalEl);
                        modal.show();
                    };
                }

                // wire up publish button
                if (document.getElementById('publishBtn') != null) {
                    document.getElementById('publishBtn').onclick = function(evt) {
                        evt.preventDefault();

                        var myModalEl = document.getElementById('publishModal');
                        var modal     = bootstrap.Modal.getOrCreateInstance(myModalEl);
                        modal.show();
                    };
                }

                if (document.getElementById('certificationPackageBtn') != null) {
                    document.getElementById('certificationPackageBtn').onclick = function(evt) {
                        evt.preventDefault();
                        showCertificationPackageModal();
                    };
                }

                if(document.querySelector('#deleteMutablePlanBtn')) {
                    document.querySelector('#deleteMutablePlanBtn').addEventListener('click', _ => {
                        var myModalEl = document.getElementById('deletePlanModal');
                        var modal     = bootstrap.Modal.getOrCreateInstance(myModalEl);
                        modal.show();
                    });
                }

                document.querySelectorAll('[data-module]')?.forEach(function(element) {
                    element.onclick = function(evt) {
                        evt.preventDefault();
                        var testName = this.dataset.module;
                        var variant = this.dataset.variant;
                        if(FAPI_UI.currentUser.sub !== data.owner.sub){
                            document.getElementById('reRunTestModalBtn').dataset.testName = testName;
                            document.getElementById('reRunTestModalBtn').dataset.variant = variant;

                            var myModalEl = document.getElementById('reRunTestModal');
                            var modal     = bootstrap.Modal.getOrCreateInstance(myModalEl);
                            modal.show();
                        } else {
                            runTest(testName, (variant !== "null") ? variant : null, planId);
                        }
                    };
                });

                document.querySelectorAll('[data-instance-id]')?.forEach(function(element) {
                    var testId = element.dataset.instanceId;

                    if (testId) {
                        // wire up the download button
                        element.querySelectorAll('.downloadBtn')?.forEach(function(element1) {
                            element1.onclick = function(evt) {
                                evt.preventDefault();
                                window.open('/api/log/export/' + encodeURIComponent(testId) + (public ? '?public=true' : ''));
                            };

                            element1.classList.add('show');
                        });

                        // show the view button
                        element.querySelectorAll('.viewBtn')?.forEach(function(element1) {
                            element1.style.display = 'inline-block';
                        });

                        fetch('/api/info/' + encodeURIComponent(testId) + (public ? '?public=true' : ''))
                        .then((response) => {
                            if (!response.ok) {
                                return Promise.reject(response);
                            }

                            return response.json();
                        })
                        .then((data) => {
                            element.querySelectorAll('.testStatusAndResult')?.forEach(function(element1) {
                                element1.innerHTML = FAPI_UI.logTemplates.TEST_STATUS({test: data});
                            });

                            element.querySelectorAll('.testVersion')?.forEach(function(element1) {
                                element1.innerHTML = FAPI_UI.logTemplates.TEST_VERSION({testVersion: data.version});
                            });

                            FAPI_UI.activeTooltip();
                            if(data.status === 'FINISHED'
                                && (["PASSED", "WARNING", "REVIEW"].includes(data.result))
                                && document.querySelector('#certificationPackageBtn')) {
                                    document.querySelector('#certificationPackageBtn').disabled = false;
                            }
                        })
                        .catch((error) => {
                            if (error instanceof Response) {
                                // We have a 'Respose' object.
                                if (error.status == 404) {
                                    // If the latest run is not accessible (an admin has re-run the test or it's unpublished),
                                    // we won't be able to fetch the status (error 404).
                                    // Just ignore it.
                                }
                                else {
                                    var message = error.statusText;
                                    var responseClone = error.clone();

                                    error.text()
                                    .then(textError => {
                                        // Text error thrown by the app
                                        messageParsed = true;

                                        try {
                                            const errorObj = JSON.parse(textError);

                                            if (errorObj.error.length != 0) {
                                                message = errorObj.error;
                                            }
                                        }
                                        catch (e) {
                                        }

                                        FAPI_UI.showError({code: error.status.toString(), error: message});
                                    })
                                    .catch(error1 => {
                                        // JSON error thrown by the app
                                        responseClone.json()
                                        .then(jsonError => {
                                            if (typeof (jsonError) === 'string' && jsonError.length != 0) {
                                                message = jsonError;
                                            }

                                            FAPI_UI.showError({code: error.status.toString(), error: message});
                                        })
                                        .catch(genericError => {
                                            // Error thrown by the server
                                            FAPI_UI.showError({code: error.status.toString(), error: error.statusText});
                                        });
                                    });
                                }
                            } else {
                                // Network error automatically detected by fetch.
                                FAPI_UI.showError({code: "", error: error});
                            }
                        });
                    } else {
                        // render an "UNKNOWN" field
                        element.querySelectorAll('.testStatusAndResult')?.forEach(function(element1) {
                            element1.innerHTML = FAPI_UI.logTemplates.TEST_STATUS({test: {}});
                        });
                        element.querySelectorAll('.testVersion')?.forEach(function(element1) {
                            element1.innerHTML = FAPI_UI.logTemplates.TEST_VERSION({testVersion: ''});
                        });
                        FAPI_UI.activeTooltip();
                    }
                });

                document.querySelectorAll('[data-publish]')?.forEach(function(element) {

                    element.onclick = function(evt) {
                        evt.preventDefault();

                        var publish = this.dataset.publish;

                        fetch('/api/plan/' + encodeURIComponent(planId) + '/publish', {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ publish: publish }),
                        })
                        .then((response) => {
                            if (!response.ok) {
                                return Promise.reject(response);
                            }

                            return response.json();
                        })
                        .then((data) => {
                            // redirect to the published version or reload
                            window.location.assign('/plan-detail.html?plan=' + encodeURIComponent(planId) + (publish ? '&public=true' : ''));
                        })
                        .catch((error) => {
                            if (error instanceof Response) {
                                // We have a 'Respose' object.
                                var message = error.statusText;
                                var responseClone = error.clone();

                                error.text()
                                .then(textError => {
                                    // Text error thrown by the app
                                    messageParsed = true;

                                    try {
                                        const errorObj = JSON.parse(textError);

                                        if (errorObj.error.length != 0) {
                                            message = errorObj.error;
                                        }
                                    }
                                    catch (e) {
                                    }

                                    FAPI_UI.showError({code: error.status.toString(), error: message});
                                })
                                .catch(error1 => {
                                    // JSON error thrown by the app
                                    responseClone.json()
                                    .then(jsonError => {
                                        if (typeof (jsonError) === 'string' && jsonError.length != 0) {
                                            message = jsonError;
                                        }

                                        FAPI_UI.showError({code: error.status.toString(), error: message});
                                    })
                                    .catch(genericError => {
                                        // Error thrown by the server
                                        FAPI_UI.showError({code: error.status.toString(), error: error.statusText});
                                    });
                                });
                            } else {
                                // Network error automatically detected by fetch.
                                FAPI_UI.showError({code: "", error: error});
                            }
                        });
                    };
                });

                //only for making an immutable plan mutable again
                document.querySelectorAll('[data-immutable]')?.forEach(function(element) {
                    element.onclick = function(evt) {
                        evt.preventDefault();

                        fetch('/api/plan/' + encodeURIComponent(planId) + '/makemutable', {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded",
                            },
                        })
                        .then((response) => {
                            if (!response.ok) {
                                return Promise.reject(response);
                            }

                            // redirect to the published version or reload
                            window.location.assign('/plan-detail.html?plan=' + encodeURIComponent(planId));
                        })
                        .catch((error) => {
                            if (error instanceof Response) {
                                // We have a 'Respose' object.
                                var message = error.statusText;
                                var responseClone = error.clone();

                                error.text()
                                .then(textError => {
                                    // Text error thrown by the app
                                    messageParsed = true;

                                    try {
                                        const errorObj = JSON.parse(textError);

                                        if (errorObj.error.length != 0) {
                                            message = errorObj.error;
                                        }
                                    }
                                    catch (e) {
                                    }

                                    FAPI_UI.showError({code: error.status.toString(), error: message});
                                })
                                .catch(error1 => {
                                    // JSON error thrown by the app
                                    responseClone.json()
                                    .then(jsonError => {
                                        if (typeof (jsonError) === 'string' && jsonError.length != 0) {
                                            message = jsonError;
                                        }

                                        FAPI_UI.showError({code: error.status.toString(), error: message});
                                    })
                                    .catch(genericError => {
                                        // Error thrown by the server
                                        FAPI_UI.showError({code: error.status.toString(), error: error.statusText});
                                    });
                                });
                            } else {
                                // Network error automatically detected by fetch.
                                FAPI_UI.showError({code: "", error: error});
                            }
                        });
                    };
                });

                document.getElementById('reRunTestModalBtn').onclick = function(evt) {
                    evt.preventDefault();
                    var testName = this.dataset.testName;
                    var variant = this.dataset.variant;
                    runTest(testName, (variant !== "null") ? variant : null, planId);
                };
            })
            .catch((error) => {
                if (error instanceof Response) {
                    // We have a 'Respose' object.
                    var message = error.statusText;
                    var responseClone = error.clone();

                    error.text()
                    .then(textError => {
                        // Text error thrown by the app
                        messageParsed = true;

                        try {
                            const errorObj = JSON.parse(textError);

                            if (errorObj.error.length != 0) {
                                message = errorObj.error;
                            }
                        }
                        catch (e) {
                        }

                        FAPI_UI.showError({code: error.status.toString(), error: message});
                    })
                    .catch(error1 => {
                        // JSON error thrown by the app
                        responseClone.json()
                        .then(jsonError => {
                            if (typeof (jsonError) === 'string' && jsonError.length != 0) {
                                message = jsonError;
                            }

                            FAPI_UI.showError({code: error.status.toString(), error: message});
                        })
                        .catch(genericError => {
                            // Error thrown by the server
                            FAPI_UI.showError({code: error.status.toString(), error: error.statusText});
                        });
                    });
                } else {
                    // Network error automatically detected by fetch.
                    FAPI_UI.showError({code: "", error: error});
                }

                // Percolate the error up.
                return Promise.reject(error);
            });
        }

        function showCertificationPackageModal() {
            document.querySelector('#document-provision-form').reset();
            document.querySelector('#certificationPackageContinue').classList.add('disabled');
            localStorage.removeItem('cocPdf');

            var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('certificationPackageModal'));
            modal.show();
        }

        function runTest(testName, testVariant, planId) {
            var runTestUrl = '/api/runner/?test=' + encodeURIComponent(testName) + '&plan=' + encodeURIComponent(planId);

            if (testVariant !== null && testVariant !== undefined) {
                runTestUrl += '&variant=' + encodeURIComponent(testVariant);
            }

            FAPI_UI.showBusy('Creating a new test for ' + testName + '...');

            fetch(runTestUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
            })
            .then((response) => {
                if (!response.ok) {
                    return Promise.reject(response);
                }

                return response.json();
            })
            .then((data) => {
                // we need to switch to the new window now
                window.location.assign('/log-detail.html?log=' + encodeURIComponent(data.id));
            })
            .catch((error) => {
                if (error instanceof Response) {
                    // We have a 'Respose' object.
                    var message = error.statusText;
                    var responseClone = error.clone();

                    error.text()
                    .then(textError => {
                        // Text error thrown by the app
                        messageParsed = true;

                        try {
                            const errorObj = JSON.parse(textError);

                            if (errorObj.error.length != 0) {
                                message = errorObj.error;
                            }
                        }
                        catch (e) {
                        }

                        FAPI_UI.showError({code: error.status.toString(), error: message});
                    })
                    .catch(error1 => {
                        // JSON error thrown by the app
                        responseClone.json()
                        .then(jsonError => {
                            if (typeof (jsonError) === 'string' && jsonError.length != 0) {
                                message = jsonError;
                            }

                            FAPI_UI.showError({code: error.status.toString(), error: message});
                        })
                        .catch(genericError => {
                            // Error thrown by the server
                            FAPI_UI.showError({code: error.status.toString(), error: error.statusText});
                        });
                    });
                } else {
                    // Network error automatically detected by fetch.
                    FAPI_UI.showError({code: "", error: error});
                }
            });
        }

        function showDialogError(containerId, error) {
            document.getElementById(containerId).insertAdjacentHTML('beforeend',
                '<div class="alert alert-danger">' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert">' +
                '</button>' + error + '</div>');
        }

        document.querySelector('#fillout-document-choice').addEventListener('click', (evt) => {
            document.querySelector('#certificationPackageContinue').href = 'form.html?plan=' + new URLSearchParams(window.location.search).get('plan');
            document.querySelector('#certificationPackageContinue').classList.remove('disabled');
        });

        document.querySelector('#certificationOfConformancePdf').addEventListener('click', (evt) => {
            document.querySelector('#upload-document-choice').checked = true;
        });

        document.querySelector('#certificationOfConformancePdf').addEventListener('change', (evt) => {
            let inputElement = evt.target;
            if (inputElement.files.length > 0) {
                let file = inputElement.files[0];
                if (file.type === 'application/pdf') {
                    if (file.size < 2 * 1024 * 1024) { // 2 MB in bytes
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            localStorage.setItem('cocPdf', e.target.result);
                            document.querySelector('#certificationPackageContinue').href = 'verify.html?plan=' + new URLSearchParams(window.location.search).get('plan');
                            document.querySelector('#certificationPackageContinue').classList.remove('disabled');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('File size exceeds 2 MB. Please choose a smaller PDF file.');
                    }
                } else {
                    alert('Please choose a PDF file.');
                }
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            var urlParams = new URLSearchParams(window.location.search);
            var planId = urlParams.get('plan');
            var public = Boolean(urlParams.get('public'));

            FAPI_UI.showBusy();

            FAPI_UI.loadPlanTemplates() // Load the templates
            .then(function() {
                return FAPI_UI.getUserInfo() // Then get the current user info
            }).then(function() {
                return getPlan(planId, public); // Only once the user is loaded, then render the plan info
            }).finally(function() {
                FAPI_UI.activeTooltip();
                FAPI_UI.hideBusy();
                if (urlParams.get('publish')) {
                    showCertificationPackageModal();
                }
            });

            var clipboard = new ClipboardJS('.btn-clipboard');
            clipboard.on('success', function(e) {
                console.log(e);
            });
            clipboard.on('error', function(e) {
                console.log(e);
            });

            document.querySelector('#confirmDeletePlanBtn').addEventListener('click', evt => {
                fetch('/api/plan/' + encodeURIComponent(planId), {
                    method:'DELETE'
                }).then(response => {
                    var myModalEl = document.getElementById('deletePlanModal');
                    var modal     = bootstrap.Modal.getInstance(myModalEl);

                    if (modal != null) {
                        modal.hide();
                    }
                    window.location.reload();
                    return;
                }).catch(error => {
                    var myModalEl = document.getElementById('deletePlanModal');
                    var modal     = bootstrap.Modal.getInstance(myModalEl);

                    if (modal != null) {
                        modal.hide();
                    }
                    FAPI_UI.showError(error);
                });
            });

        });
    </script>


    <footer class="pageFooter">
        <span class="muted">OpenID Foundation conformance suite</span>
    </footer>

</body>

</html>
